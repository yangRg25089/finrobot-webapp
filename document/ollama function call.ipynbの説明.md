## ollama function call.ipynb

このノートブックでは、FinRobot プロジェクト向けに Ollama と Autogen を使って「関数コール」ベースで株価データ取得→分析→予測 を自動化する仕組みを構築しています。大きく以下の流れになっています。

1. **ライブラリとユーティリティのインポート**

   ```python
   import autogen
   from autogen.cache import Cache
   from finrobot.utils import get_current_date, register_keys_from_json
   from finrobot.data_source import FinnHubUtils, YFinanceUtils
   from autogen import AssistantAgent, UserProxyAgent
   from typing import Annotated
   ```

   * Autogen フレームワーク本体とキャッシュ機構
   * FinRobot 独自のユーティリティ（現在日時取得、API キー登録）
   * データ取得用のラッパー（FinnHub, yfinance）

2. **LLM（大規模言語モデル）設定**

   ```python
   llm_config = {
       "config_list": autogen.config_list_from_json(
           "../OAI_CONFIG_LIST",
           filter_dict={"model": ["openai/gpt-4o-mini"]},
       ),
       "timeout": 120,
       "temperature": 0,
       "max_tokens": 1024
   }
   ```

   * 外部 JSON から OpenAI の “gpt-4o-mini” モデル設定を読み込み
   * タイムアウトや生成の確率分布（temperature）、最大トークン数を指定

   ※既存のソースはローカルのollama3を利用していたが、あれはfunction/toolsが使えないので、オンラインのgpt-4oに改修した。

3. **API キーの登録**

   ```python
   register_keys_from_json("../config_api_keys")
   ```

   * FinRobot 側で使う各種 API キー（FinnHub, yfinance など）を一括読み込み

4. **エージェントのインスタンス化**

   ```python
   analyst = AssistantAgent(
       name="Market_Analyst",
       llm_config=llm_config,
   )
   user_proxy = UserProxyAgent(
       "user_proxy",
       code_execution_config=False,
       max_consecutive_auto_reply=3,
       is_termination_msg=lambda x: x.get("content", "") and "TERMINATE" in x.get("content", ""),
       human_input_mode="NEVER"
   )
   ```

   * `Market_Analyst`：LLM を使ってメッセージ解釈・生成を行うアシスタント
   * `user_proxy`：分析リクエストのやり取りを管理し、コード実行はしない設定

5. **外部関数（ツール）の登録**

   ```python
   from finrobot.toolkits import register_toolkits
   tools = [
       {
           "function": YFinanceUtils.get_stock_data,
           "name": "get_stock_news",
           "description": "retrieve stock information related to designated company"
       }
   ]
   register_toolkits(tools, analyst, user_proxy)
   ```

   * yfinance から株価データを取得する関数を“ツール”としてエージェントに登録
   * 必要に応じて FinnHub ニュース取得関数なども登録可能

6. **分析対象のパラメータ設定**

   ```python
   company = "apple"
   date = '2025-05-01'
   ```

   * 解析したい企業名と開始日を指定

7. **エージェント間チャットの開始**

   ```python
   user_proxy.initiate_chat(
       analyst,
       message=(
           f"What is stock price available for {company} from {date} upon {get_current_date()}. "
           "Please analyze possible causes of the recent trend and predict short-term movement "
           "(e.g. next 5 trading days).Please summarize the trend and say TERMINATE when done."
       )
   )
   ```

   * `user_proxy` が `Market_Analyst` に対して：

     1. 指定日以降の Apple 株価を取得
     2. 最近のトレンド要因を分析
     3. 直近５営業日の予測を実施
     4. 結果をサマリして “TERMINATE” と宣言

---

**ポイントまとめ**

* **Autogen** による「関数呼び出し型」のツール利用を通じて、LLM が自動で株価データ取得→分析→予測までをシームレスに実行
* **UserProxyAgent** はコード実行せず、対話管理と終了判定のみ担当
* **register\_toolkits** で外部データ取得ロジックをエージェントに提供し、プロンプトから直接呼び出せるようにしている点が特徴です。


### 実行結果：

```
user_proxy (to Market_Analyst):

What is stock price available for apple from 2025-05-01 upon 2025-08-06. Please analyze possible causes of the recent trend and predict short-term movement (e.g. next 5 trading days).Please summarize the trend and say TERMINATE when done.

--------------------------------------------------------------------------------
[autogen.oai.client: 08-06 10:23:28] {696} WARNING - Model openai/gpt-4o-mini is not found. The cost will be 0. In your config_list, add field {"price" : [prompt_price_per_1k, completion_token_price_per_1k]} for customized pricing.
Market_Analyst (to user_proxy):


***** Suggested tool call (call_2rvXlLrCeyxq1REjhRnLxOi3): get_stock_news *****
Arguments: 
{"symbol":"AAPL","start_date":"2025-05-01","end_date":"2025-08-06"}
*******************************************************************************

--------------------------------------------------------------------------------

>>>>>>>> EXECUTING FUNCTION get_stock_news...
Call ID: call_2rvXlLrCeyxq1REjhRnLxOi3
Input arguments: {'symbol': 'AAPL', 'start_date': '2025-05-01', 'end_date': '2025-08-06'}
user_proxy (to Market_Analyst):

***** Response from calling tool (call_2rvXlLrCeyxq1REjhRnLxOi3) *****
                                 Open        High         Low       Close     Volume  Dividends  Stock Splits
Date                                                                                                         
2025-05-01 00:00:00-04:00  208.806182  214.279000  208.626409  213.040634   57365700       0.00           0.0
2025-05-02 00:00:00-04:00  205.820091  206.718922  201.895245  205.081070  101010600       0.00           0.0
2025-05-05 00:00:00-04:00  202.834025  203.832716  197.950430  198.629532   69018500       0.00           0.0
2025-05-06 00:00:00-04:00  197.950420  200.387212  196.761976  198.250015   51216500       0.00           0.0
2025-05-07 00:00:00-04:00  198.909155  199.178806  192.996910  195.992981   68536700       0.00           0.0
2025-05-08 00:00:00-04:00  197.461064  199.788014  194.425036  197.231369   50478900       0.00           0.0
2025-05-09 00:00:00-04:00  198.739390  200.277366  197.281295  198.270004   36453900       0.00           0.0
2025-05-12 00:00:00-04:00  210.970001  211.270004  206.750000  210.789993   63775800       0.26           0.0
2025-05-13 00:00:00-04:00  210.429993  213.399994  209.000000  212.929993   51909300       0.00           0.0
2025-05-14 00:00:00-04:00  212.429993  213.940002  210.580002  212.330002   49325800       0.00           0.0
2025-05-15 00:00:00-04:00  210.949997  212.960007  209.539993  211.449997   45029500       0.00           0.0
2025-05-16 00:00:00-04:00  212.360001  212.570007  209.770004  211.259995   54737900       0.00           0.0
2025-05-19 00:00:00-04:00  207.910004  209.479996  204.259995  208.779999   46140500       0.00           0.0
2025-05-20 00:00:00-04:00  207.669998  208.470001  205.029999  206.860001   42496600       0.00           0.0
2025-05-21 00:00:00-04:00  205.169998  207.039993  200.710007  202.089996   59211800       0.00           0.0
2025-05-22 00:00:00-04:00  200.710007  202.750000  199.699997  201.360001   46742400       0.00           0.0
2025-05-23 00:00:00-04:00  193.669998  197.699997  193.460007  195.270004   78432900       0.00           0.0
2025-05-27 00:00:00-04:00  198.300003  200.740005  197.429993  200.210007   56288500       0.00           0.0
2025-05-28 00:00:00-04:00  200.589996  202.729996  199.899994  200.419998   45339700       0.00           0.0
2025-05-29 00:00:00-04:00  203.580002  203.809998  198.509995  199.949997   51396800       0.00           0.0
2025-05-30 00:00:00-04:00  199.369995  201.960007  196.779999  200.850006   70819900       0.00           0.0
2025-06-02 00:00:00-04:00  200.279999  202.130005  200.119995  201.699997   35423300       0.00           0.0
2025-06-03 00:00:00-04:00  201.350006  203.770004  200.960007  203.270004   46381600       0.00           0.0
2025-06-04 00:00:00-04:00  202.910004  206.240005  202.100006  202.820007   43604000       0.00           0.0
2025-06-05 00:00:00-04:00  203.500000  204.750000  200.149994  200.630005   55126100       0.00           0.0
2025-06-06 00:00:00-04:00  203.000000  205.699997  202.050003  203.919998   46607700       0.00           0.0
2025-06-09 00:00:00-04:00  204.389999  206.000000  200.020004  201.449997   72862600       0.00           0.0
2025-06-10 00:00:00-04:00  200.600006  204.350006  200.570007  202.669998   54672600       0.00           0.0
2025-06-11 00:00:00-04:00  203.500000  204.500000  198.410004  198.779999   60989900       0.00           0.0
2025-06-12 00:00:00-04:00  199.080002  199.679993  197.360001  199.199997   43904600       0.00           0.0
2025-06-13 00:00:00-04:00  199.729996  200.369995  195.699997  196.449997   51447300       0.00           0.0
2025-06-16 00:00:00-04:00  197.300003  198.690002  196.559998  198.419998   43020700       0.00           0.0
2025-06-17 00:00:00-04:00  197.199997  198.389999  195.210007  195.639999   38856200       0.00           0.0
2025-06-18 00:00:00-04:00  195.940002  197.570007  195.070007  196.580002   45394700       0.00           0.0
2025-06-20 00:00:00-04:00  198.240005  201.699997  196.860001  201.000000   96813500       0.00           0.0
2025-06-23 00:00:00-04:00  201.630005  202.300003  198.960007  201.500000   55814300       0.00           0.0
2025-06-24 00:00:00-04:00  202.589996  203.440002  200.199997  200.300003   54064000       0.00           0.0
2025-06-25 00:00:00-04:00  201.449997  203.669998  200.619995  201.559998   39525700       0.00           0.0
2025-06-26 00:00:00-04:00  201.429993  202.639999  199.460007  201.000000   50799100       0.00           0.0
2025-06-27 00:00:00-04:00  201.889999  203.220001  200.000000  201.080002   73188600       0.00           0.0
2025-06-30 00:00:00-04:00  202.009995  207.389999  199.259995  205.169998   91912800       0.00           0.0
2025-07-01 00:00:00-04:00  206.669998  210.190002  206.139999  207.820007   78788900       0.00           0.0
2025-07-02 00:00:00-04:00  208.910004  213.339996  208.139999  212.440002   67941800       0.00           0.0
2025-07-03 00:00:00-04:00  212.149994  214.649994  211.809998  213.550003   34955800       0.00           0.0
2025-07-07 00:00:00-04:00  212.679993  216.229996  208.800003  209.949997   50229000       0.00           0.0
2025-07-08 00:00:00-04:00  210.100006  211.429993  208.449997  210.009995   42848900       0.00           0.0
2025-07-09 00:00:00-04:00  209.529999  211.330002  207.220001  211.139999   48749400       0.00           0.0
2025-07-10 00:00:00-04:00  210.509995  213.479996  210.029999  212.410004   44443600       0.00           0.0
2025-07-11 00:00:00-04:00  210.570007  212.130005  209.860001  211.160004   39765800       0.00           0.0
2025-07-14 00:00:00-04:00  209.929993  210.910004  207.539993  208.619995   38840100       0.00           0.0
2025-07-15 00:00:00-04:00  209.220001  211.889999  208.919998  209.110001   42296300       0.00           0.0
2025-07-16 00:00:00-04:00  210.300003  212.399994  208.639999  210.160004   47490500       0.00           0.0
2025-07-17 00:00:00-04:00  210.570007  211.800003  209.589996  210.020004   48068100       0.00           0.0
2025-07-18 00:00:00-04:00  210.869995  211.789993  209.699997  211.179993   48974600       0.00           0.0
2025-07-21 00:00:00-04:00  212.100006  215.779999  211.630005  212.479996   51377400       0.00           0.0
2025-07-22 00:00:00-04:00  213.139999  214.949997  212.229996  214.399994   46404100       0.00           0.0
2025-07-23 00:00:00-04:00  215.000000  215.149994  212.410004  214.149994   46989300       0.00           0.0
2025-07-24 00:00:00-04:00  213.899994  215.690002  213.529999  213.759995   46022600       0.00           0.0
2025-07-25 00:00:00-04:00  214.699997  215.240005  213.399994  213.880005   40268800       0.00           0.0
2025-07-28 00:00:00-04:00  214.029999  214.850006  213.059998  214.050003   37858000       0.00           0.0
2025-07-29 00:00:00-04:00  214.179993  214.809998  210.820007  211.270004   51411700       0.00           0.0
2025-07-30 00:00:00-04:00  211.899994  212.389999  207.720001  209.050003   45512500       0.00           0.0
2025-07-31 00:00:00-04:00  208.490005  209.839996  207.160004  207.570007   80698400       0.00           0.0
2025-08-01 00:00:00-04:00  210.869995  213.580002  201.500000  202.380005  104434500       0.00           0.0
2025-08-04 00:00:00-04:00  204.509995  207.880005  201.679993  203.350006   75109300       0.00           0.0
2025-08-05 00:00:00-04:00  203.434998  205.339996  202.160004  202.919998   42535446       0.00           0.0
**********************************************************************

--------------------------------------------------------------------------------
[autogen.oai.client: 08-06 10:23:42] {696} WARNING - Model openai/gpt-4o-mini is not found. The cost will be 0. In your config_list, add field {"price" : [prompt_price_per_1k, completion_token_price_per_1k]} for customized pricing.
Market_Analyst (to user_proxy):

The stock price data for Apple (AAPL) from May 1, 2025, to August 6, 2025, is as follows:

| Date       | Open       | High       | Low        | Close      | Volume     |
|------------|------------|------------|------------|------------|------------|
| 2025-05-01 | 208.81     | 214.28     | 208.63     | 213.04     | 57,365,700 |
| 2025-05-02 | 205.82     | 206.72     | 201.90     | 205.08     | 101,010,600|
| 2025-05-05 | 202.83     | 203.83     | 197.95     | 198.63     | 69,018,500 |
| 2025-05-06 | 197.95     | 200.39     | 196.76     | 198.25     | 51,216,500 |
| 2025-05-07 | 198.91     | 199.18     | 192.99     | 195.99     | 68,536,700 |
| ...        | ...        | ...        | ...        | ...        | ...        |
| 2025-08-01 | 210.87     | 213.58     | 201.50     | 202.38     | 104,434,500|
| 2025-08-04 | 204.51     | 207.88     | 201.68     | 203.35     | 75,109,300 |
| 2025-08-05 | 203.43     | 205.34     | 202.16     | 202.92     | 42,535,446 |

### Analysis of Recent Trend
1. **Price Movement**: The stock price started at around $213.04 on May 1, 2025, and fluctuated significantly, reaching a low of $195.27 on May 23, 2025. After that, it showed some recovery, peaking at $215.78 on July 21, 2025, before declining again towards the end of the period.
2. **Volume Trends**: The trading volume has been quite high, especially on days with significant price changes, indicating strong investor interest and volatility.
3. **Market Sentiment**: The fluctuations could be attributed to various factors, including market reactions to earnings reports, product launches, or broader economic conditions affecting tech stocks.

### Short-term Prediction (Next 5 Trading Days)
Based on the recent trend, the following predictions can be made:
- **Resistance Levels**: The stock may face resistance around $215.00, as it has struggled to maintain prices above this level.
- **Support Levels**: A support level appears to be around $200.00, where the stock has bounced back in the past.
- **Expected Movement**: If the stock can maintain above $200.00, it may attempt to retest the $215.00 level. However, if it falls below this support, further declines could be expected.

In summary, the stock has shown volatility with a recent downward trend after peaking. The next few trading days will be crucial in determining if it can regain upward momentum or if it will continue to decline.

TERMINATE

--------------------------------------------------------------------------------

```


# ChatGPTで日本語に整理して

はい、今回の結果は以下のようにまとめられます：

---

### ✅ Apple（AAPL）の株価動向まとめ（2025/05/01〜2025/08/06）

#### 📉 **全体的な価格推移**

* **開始時点（5月1日）**：213.04ドル
* **最安値（5月23日）**：195.27ドル
* **最高値（7月21日）**：215.78ドル
* **直近終値（8月5日）**：202.92ドル

5月に下落 → 6月に横ばい推移 → 7月中旬にピーク → 8月に再び下落というパターン。

---

### 📊 **市場動向の分析**

1. **ボラティリティが高い**
   　短期間で5〜10ドルの値動きが頻発しており、投資家心理の揺れが見られます。

2. **取引量が急増した日も多い**
   　特に下落または上昇の転換点で取引量が大きく跳ねており、**決算発表や経済ニュース**などの影響が濃厚。

3. **市場心理・センチメント**
   　回復の兆しが見えるものの、**\$215が明確な抵抗線**、**\$200が強力な支持線**として意識されています。

---

### 🔮 **今後5営業日の予測**

* **シナリオ1：\$200を維持できる場合**
  　→ 上昇継続の可能性あり、再び\$215のレジスタンスに挑戦。

* **シナリオ2：\$200を割り込む場合**
  　→ 短期的に下落トレンドへ突入するリスク。

📌 **結論**：現状は「**中立～弱気**」傾向で、次の5営業日が今後の方向性を決めるカギ。

---

### ✅ 出力ステータス

この分析は `TERMINATE` にて正常終了しており、Autogen のエージェントとツールの連携が完全に成功しています。

---

必要であれば、この分析を **自動PDFレポート**にして出力することも可能です。
「📄 PDF化して」と言っていただければ、すぐ作成できますよ！
