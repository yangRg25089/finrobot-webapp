# 使用 BackTrader 的交易策略智能体 — 脚本功能说明

## 概览

这个脚本将大语言模型（LLM）作为**量化交易策略师**，全流程自动完成：

1. **生成自定义 BackTrader 策略代码**（如 `my_strategy.py`）。
2. **回测策略**在指定股票和时间区间的表现。
3. **多轮优化**（调整代码 → 再回测）以追求击败“买入并持有”基准策略。
4. **保存成果**（策略文件、回测图表）到独立的带时间戳的输出目录，便于前端展示。

---

## 核心组件

### 智能体（Agents）

* **Trade\_Strategist（AssistantAgent）**

  * 负责编写策略代码、调用回测工具并进行优化。
* **User\_Proxy（UserProxyAgent）**

  * 执行工具调用（写文件、修改代码、运行回测、显示图片）。
  * 管理当前任务的工作目录 `work_dir`。

### 工具（Toolkits）

* **代码写入工具**（`register_code_writing`）：将生成的策略代码保存到任务工作目录。
* **回测工具**（`BackTraderUtils.back_test`）：导入策略模块、运行回测、保存回测结果图。
* **图表展示工具**（`IPythonUtils.display_image`）：在对话中显示保存的回测图表。

---

## 数据流（执行步骤）

1. **初始化环境**

   * 生成 LLM 配置（模型参数、温度、超时等）。
   * 创建带时间戳的 `work_dir` 并加入 `sys.path` 与 `PYTHONPATH`。
2. **分配任务**

   * 指定股票代码、时间范围、严格的策略与回测调用规则（文件名、类名、保存图名等）。
3. **生成策略**

   * LLM 调用代码写入工具，生成 `my_strategy.py`（包含 `MyStrategy` 类，可选 `CustomSizer`）。
4. **执行回测**

   * 调用 `BackTraderUtils.back_test(...)`，加载策略并运行回测，保存资金曲线等图表。
5. **迭代优化**

   * 根据回测结果，自动修改策略代码并再次回测。
6. **输出结果**

   * 收集生成的文件和图表路径，并返回给 FastAPI 或其他前端系统。

---

## 总结

该脚本的核心作用是构建一个**由 AI 驱动的自动化量化交易策略开发与回测平台**。

是的，这个脚本生成和优化出来的策略**本质上就是投资策略**，而且它既可以用来验证“一次买入持有到结束”的收益，也可以用来设计“多次买卖、择机进出”的收益模式。

我帮你分成两种典型应用来解释：

---

## 1. 一次买入持有（Buy & Hold）

* **做法**：在回测中，把策略代码写成“买入后不再卖出，直到结束日清仓”。
* **用途**：

  * 测试长期投资的收益表现（例如持有微软 2022-2024 两年的涨幅）。
  * 作为**基准策略**，AI 会尝试让新策略跑赢它。
* **结果输出**：

  * 资金曲线图（显示持有期间资金变化）
  * 总收益率、最大回撤等指标

---

## 2. 多次买卖（Active Trading）

* **做法**：策略里写入进出场条件（均线交叉、突破、动量指标等）。
* **用途**：

  * 模拟波段交易、趋势跟随等方法，判断是否能提高收益。
  * 控制风险（如止损、分批买入卖出）。
* **结果输出**：

  * 交易明细（每次买卖的时间、价格、仓位）
  * 资金曲线 + 和 Buy & Hold 的对比
  * 绩效指标（胜率、盈亏比、夏普比率等）

---

## 总结

这个脚本的主要价值是**自动化生成与优化投资策略**，并用历史数据回测验证：

* 可以用来回答 **“如果我一次买入会赚多少”**
* 也可以用来回答 **“如果我多次买卖会不会赚更多”**
* 还能反复让 AI 优化代码，让策略在历史数据中跑得更好。

如果你愿意，我可以帮你把这个脚本直接改成**同时回测 Buy & Hold 和多次买卖策略，并输出对比图表**，这样一次就能看出谁更赚钱。这样就不用分两次跑。
